{% extends "index.html" %}
{% block body %}
<div class="container">
  <div class='row'>
  	<div class="col-md-12">
		<ul class="breadcrumb">
		  <li><a href="/7_layer_access/">7层接入管理</a> <span class="divider"></span></li>
		  <li class="active">新增7层接入实例</li>
		</ul>
  	</div>
  </div>

  <div class='row'>
  	<div class='col-md-12' id='7_layer_access_new_item_body'>
  		<h4>7层接入实例</h4>
  		<hr>
	  	<form class="form-horizontal">

            <div class="control-group">
		      <label class="control-label" for="descript">接入业务名称</label>
		      <div class="controls">
		        <td><input id="descript" class="7_layer_access_new_item_input" type="text" name='descript' placeholder="业务名, 例如: 123-nginx"></td>
		      </div>
            </div>

            <div class="control-group">
		      <label class="control-label" for="protocol">接入业务所在IDC</label>
		      <div class="controls">
		        <select id="protocol" class="7_layer_access_new_item_input" name='protocol'>
                    {% for idc in idcList %}
		        	<option value= {{ idc }} > {{ idc }} </option>
                    {% endfor %}
		        </select>
		      </div>
		    </div>



			<div class="control-group">
		      <label class="control-label" for="vipinstance">VIP实例</label>
		      <div class="controls">
		        <td><input id="vip_instance" class="7_layer_access_new_item_input" type="text" name='vip_instance' check-type="required"><span class="help-block">VIP实例，在集群中必须是唯一</span></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="descript">业务</label>
		      <div class="controls">
		        <td><input id="descript" class="7_layer_access_new_item_input" type="text" name='descript' placeholder="业务名"></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="owners">负责人</label>
		      <div class="controls">
		        <td><input id="owners" class="7_layer_access_new_item_input" type="text" name='owners' placeholder="负责人"></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="mailto">警告邮件列表</label>
		      <div class="controls">
		        <td><input style="width: 310px;" id="mailto" class="7_layer_access_new_item_input" type="text" name='mailto' placeholder="以逗号分割"><span class="help-block">警告邮件列表,以逗号分割,例如:xxxx@xx.xx,xxxx@xx.xx</span></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="vip_group">vip组</label>
		      <div class="controls">
		        <td><input style="width: 310px;" id="vip_group" class="7_layer_access_new_item_input" type="text" name='vip' placeholder="vip地址"><span class="help-block">vip组列表,以逗号分割.例如:1.1.1.1:80,2.2.2.2:80</span></td>
		      </div>
		    </div>
		  
		    <div class="control-group">
		      <label class="control-label" for="vip_nic">vip绑定的物理网卡名称</label>
		      <div class="controls">
		        <td><input style="width: 310px;" id="vip_nic" class="7_layer_access_new_item_input" type="text" name='vip_nic' placeholder="eth0"></td>
		      </div>
		    </div>

		    <div class="control-group">
		      <label class="control-label" for="protocol">协议</label>
		      <div class="controls">
		        <select id="protocol" class="7_layer_access_new_item_input" name='protocol'>
		        	<option value='TCP'>TCP</option>
		        	<option value='UDP'>UDP</option>
		        </select>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="delay_loop">检测间隔</label>
		      <div class="controls">
		        <td><input style="width: 40px;" id="delay_loop" class="7_layer_access_new_item_input" type="text" name='delay_loop' placeholder="检测间隔" value="6"></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="lb_algo">调度方法</label>
		      <div class="controls">
		        <select id="lb_algo" class="7_layer_access_new_item_input" name='lb_algo'>
		        	<option value='rr'>rr</option>
		        	<option value='wrr'>wrr</option>
		        	<option value='lc'>lc</option>
		        	<option value='wlc'>wlc</option>
		        	<option value='lblc'>lblc</option>
		        	<option value='sh'>sh</option>
		        	<option value='dh'>dh</option>
		        </select>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="lb_kind">调度模式</label>
		      <div class="controls">
		        <select id="lb_kind" class="7_layer_access_new_item_input" name='lb_kind'>
		        	<option value='FNAT'>FNAT</option>
		        	<option value='DR'>DR</option>
		        	<option value='NAT'>NAT</option>
		        	<option value='TUN'>TUN</option>
		        </select>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="persistence_timeout">会话保持时间</label>
		      <div class="controls">
		        <td><input style="width: 40px;" id="persistence_timeout" class="7_layer_access_new_item_input" type="text" name='persistence_timeout' placeholder="会话保持时间" value='0' ></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="sync_proxy">sync_proxy防御</label>
		      <div class="controls">
		        <td><input id="sync_proxy" class="lvs_manager_deploy_add_vip_checkbox " name='sync_proxy' type='checkbox' value='True' checked="true"></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="alpha">alpha</label>
		      <div class="controls">
		        <td><input id="alpha" class="lvs_manager_deploy_add_vip_checkbox" name='alpha' type='checkbox' value='True' checked="true"><span class="help-block">是否开启alpha模式,启动时默认rs是down状态，健康检查通过后才添加到lvs pool</span></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="omega">omega</label>
		      <div class="controls">
		        <td><input id="omega" class="lvs_manager_deploy_add_vip_checkbox" name='omega' type='checkbox' value='True' checked="true"><span class="help-block">是否开启omega模式，清楚rs时会执行相应的脚本(quorum_up)</span></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="quorum">quorum</label>
		      <div class="controls">
		        <td><input style="width: 40px;" id="quorum" class="7_layer_access_new_item_input" type="text" name='quorum' value='1' ><span class="help-block">服务是否有效的阀值</span></td>
		      </div>
		    </div>
		    <div class="control-group">
		      <label class="control-label" for="hysteresis">hysteresis</label>
		      <div class="controls">
		        <td><input style="width: 40px;" id="hysteresis" class="7_layer_access_new_item_input" type="text" name='hysteresis' value='0'><span class="help-block">延迟系数，跟quorum配合使用</span></td>
		      </div>
		    </div>
		</form>
		</br>
		<h4>RealServer组</h4>
		<hr>
		<button id="rs_add" class='btn btn-success'><span class="fui-plus"></span>添加RS</button>
		<table class="table table-bordered table-hover">
			  <thead>
			    <tr>
			      <th style="width: 10%">管理IP</th>
			      <th style="width: 10%">服务IP</th>
			      <th style="width: 10%">权重</th>
			      <th style="width: 40%">port列表</th>
			      <th style="width: 10%">监控方式</th>
			      <th>操作</th>
			    </tr>
			  </thead>
			  <tbody id='rs_talbe_body'>
			  </tbody>
		</table>
		<hr>
		<button style="position: relative;left: 800px;" class='btn btn-danger' id="lvs_deploy_add_submit" ><span class="fui-checkbox-checked"></span>提交</button>
		<a href="/lvsmanager_deploy/?id={{ cluster }}" style="position: relative;left: 800px;" class='btn btn-primary'><span class="fui-arrow-left"></span>返回</a>
  	</div>
  </div>



<div id="dialog-form" title="新增RS配置">
  <form>
  <fieldset>
    <div class="control-group">
      <label class="control-label" for="manager_ip">管理IP</label>
      <div class="controls">
        <td><input id="manager_ip" type="text" name='manager_ip'><span class="help-block">用于登录管理的IP</span></td>
      </div>
	</div>
	<div class="control-group">
      <label class="control-label" for="server_ip">服务IP</label>
      <div class="controls">
        <td><input id="server_ip" type="text" name='server_ip'><span class="help-block">用于RS提供服务的IP</span></td>
      </div>
	</div>
	<div class="control-group">
      <label class="control-label" for="weight">权重</label>
      <div class="controls">
        <td><input id="weight" type="text" name='weight'><span class="help-block">用于调节RS的负载压力</span></td>
      </div>
	</div>
	<div class="control-group">
      <label class="control-label" for="rs_port">port列表</label>
      <div class="controls">
        <td><input id="rs_port" type="text" name='rs_port'><span class="help-block">端口的列表,以逗号分割</span></td>
      </div>
	</div>
	<div class="control-group">
      <label class="control-label" for="monitor_type">监控方式</label>
      <div class="controls">
        <select id="monitor_type" name='monitor_type'>
	    	<option value='HTTP_GET'>HTTP_GET</option>
	    	<option value='TCP_CHECK'>TCP_CHECK</option>
	    	<option value='MISC_CHECK'>MISC_CHECK</option>
		</select>
      </div>
	</div>
	<div id="monitor_method">
		<div class="control-group">
	      <label class="control-label" for="path">path</label>
	      <div class="controls">
	        <td><input id="path" class="monitor_method_input" type="text" name='path'></td>
	      </div>
		</div>
		<div class="control-group">
	      <label class="control-label" for="digest">digest</label>
	      <div class="controls">
	        <td><input id="digest" class="monitor_method_input" type="text" name='digest'></td>
	      </div>
		</div>
		<div class="control-group">
	      <label class="control-label" for="connect_timeout">连接超时时间</label>
	      <div class="controls">
	        <td><input id="connect_timeout" class="monitor_method_input" type="text" name='connect_timeout'></td>
	      </div>
		</div>
		<div class="control-group">
	      <label class="control-label" for="nb_get_retry">重连次数</label>
	      <div class="controls">
	        <td><input id="nb_get_retry" class="monitor_method_input" type="text" name='nb_get_retry'></td>
	      </div>
		</div>
		<div class="control-group">
	      <label class="control-label" for="delay_before_retry">重连间隔时间</label>
	      <div class="controls">
	        <td><input id="delay_before_retry" class="monitor_method_input" type="text" name='delay_before_retry'></td>
	      </div>
		</div>
	</div>
  </fieldset>
  </form>
</div>

</div>
<script type="text/javascript">
	var rs_list = []
	//onselect monitor_type
	$("#monitor_type").change(function() {
		var monitor_type = $("#monitor_type").val()
		if (monitor_type == 'TCP_CHECK') {
			inputlist = {"connect_timeout":"超时时间"} ;
		}
		else if (monitor_type == 'HTTP_GET') {
			inputlist = {"path":"path","digest":"digest","connect_timeout":"超时时间","nb_get_retry":"重连次数","delay_before_retry":"重连间隔时间"} ;
		}
		else {
			inputlist = {"misc_path":"执行脚本","misc_timeout":"超时时间"} ;
		} ;

		_html = format_monitor_method_input(inputlist) ;
		$("#monitor_method").html(_html) ;
	});

	$( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 600,
      width: 400,
      modal: true,
      buttons: {
        "保存": function() {
        	monitor_new = new Object ;
        	monitor = new Object ;
        	monitor_new['manager_ip'] = $("#manager_ip").val() ;
        	monitor_new['server_ip'] = $("#server_ip").val() ;
        	monitor_new['port'] = $("#rs_port").val() ;
        	monitor_new['weight'] = $("#weight").val() ;
        	monitor['type'] = $("#monitor_type").val() ;
        	$(".monitor_method_input").each(function() {
        		var key = $(this).attr('id') ;
        		var value = $(this).val() ;
        		monitor[key] = value ;
        	})
        	monitor_new['monitor'] = monitor ;
        	rs_list.push(monitor_new) ;
        	rs_table() ;
            $( this ).dialog( "close" );
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      },
      close: function() {
        
      }

    });

	$("#rs_add").click(function() {
		$( "#dialog-form" ).dialog( "open" );
	});

	function rs_table() {
		var html = ''
		for (rs in rs_list) {
			_rs = rs_list[rs]
			html += '<tr><td>' + _rs['manager_ip'] + '</td><td>' + _rs['server_ip'] + '</td><td>' +
			_rs['weight'] + '</td><td>' + _rs['port'] + '</td><td>' +_rs['monitor']['type'] + '</td><td><a href="javascript:rs_remove(' + rs + ')" ><span class="fui-cross"></span>delete</a></td></tr>'
		}
		$("#rs_talbe_body").html(html)
	};


	function format_monitor_method_input(input_list) {
		var html = ''
		for (i in input_list) {
			html += '<div class="control-group"><label class="control-label" for="' + i + '">' + input_list[i] + '</label> <div class="controls">' +
	     			'<td><input class="monitor_method_input" id="' + i + '" type="text" name="' + i + '"></td></div></div>'
		}
		return html
	};


	$("#lvs_deploy_add_submit").click(function() {
		var _rs_list = []
		post_data = new Object() ;
		post_data['cluster_id'] = "{{ cluster }}"
		$(".7_layer_access_new_item_input").each(function() {
			var key = $(this).attr('id') ;
			var value = $(this).val() ;
			post_data[key] = value ;
		})
		$(".lvs_manager_deploy_add_vip_checkbox").each(function() {
			var key = $(this).attr('id') ;
			var value = $(this).attr('checked') ;
			if (value == 'checked') {
				var _value = true
			} else {
				var _value = false
			}
			post_data[key] = _value ;
		})
		for (rs in rs_list) {
			if ( rs_list[rs] ) {
				_rs_list.push(rs_list[rs])
			}
		};
		post_data['rs'] = _rs_list ;
		var _post_data = $.toJSON(post_data)
		var loading=new ol.loading({id:"lvsmanager_deploy_add_body"}) ;
		$.ajax({
		  type: 'POST' ,
          url: '/lvsmanager_deploy_add/' ,
          data: _post_data ,
          cache: false ,
          beforeSend: function() { loading.show()} ,
          success: function(data) {
          		loading.hide()  ;
               	window.location.href="/lvsmanager_deploy/?id={{ cluster }}"
          },
          error: function(XMLHttpRequest) {
          	loading.hide()  ;
          	bootbox.alert('提交失败:' + XMLHttpRequest)
          }
      });

	})

	function rs_remove(rs_num) {
		delete rs_list[rs_num] ;
		rs_table() ;
	};

</script>
{% endblock %}
