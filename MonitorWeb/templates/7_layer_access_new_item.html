{% extends "index.html" %}
{% block body %}
<div class="container">
  <div class='row'>
  	<div class="col-md-12">
		<ul class="breadcrumb">
		  <li><a href="/7_layer_access/">7层接入管理</a> <span class="divider"></span></li>
		  <li class="active">新增7层接入实例</li>
		</ul>
  	</div>
  </div>

  <div class='row'>
  	<div class='col-md-12' id='7_layer_access_new_item_body'>
  		<h4>7层接入实例</h4>
  		<hr>

	  	<form class="form-horizontal">

            <div class="control-group">
		      <label class="control-label" for="descript">接入业务名称</label>
		      <div class="controls">
		        <td><input id="descript" class="7_layer_access_new_item_input" type="text" name='descript' placeholder="业务名, 例如: 123-nginx"></td>
		      </div>
            </div>

            <div class="control-group">
		      <label class="control-label" for="protocol">接入业务所在IDC</label>
		      <div class="controls">
		        <select id="protocol" class="7_layer_access_new_item_input" name='protocol'>
                    {% for idc in idcList %}
		        	<option value= {{ idc }} > {{ idc }} </option>
                    {% endfor %}
		        </select>
		      </div>
		    </div>

            <div class="control-group">
		      <label class="control-label" for="descript">接入业务域名(Host)</label>
		      <div class="controls">
		        <td><input id="descript" class="7_layer_access_new_item_input" type="text" name='descript' placeholder="域名, 例如: www.thewayma.com"></td>
		      </div>
            </div>

            <div class="control-group">
		      <label class="control-label" for="descript">接入业务源站服务器信息(Upstream)</label>
		      <div class="controls">
		        <td><input id="descript" class="7_layer_access_new_item_input" type="text" name='descript' placeholder="upstream, 例如: 1.1.1.1:80,2.2.2.2,3.3.3.3:8080 即多个源站ip用","分割></td>
		      </div>
            </div>
		</form>

		<button style="position: relative;left: 800px;" class='btn btn-danger' id="lvs_deploy_add_submit" ><span class="fui-checkbox-checked"></span>提交</button>
		<a href="/lvsmanager_deploy/?id={{ cluster }}" style="position: relative;left: 800px;" class='btn btn-primary'><span class="fui-arrow-left"></span>返回</a>
  	</div>
  </div>



</div>
<script type="text/javascript">
	var rs_list = []
	//onselect monitor_type
	$("#monitor_type").change(function() {
		var monitor_type = $("#monitor_type").val()
		if (monitor_type == 'TCP_CHECK') {
			inputlist = {"connect_timeout":"超时时间"} ;
		}
		else if (monitor_type == 'HTTP_GET') {
			inputlist = {"path":"path","digest":"digest","connect_timeout":"超时时间","nb_get_retry":"重连次数","delay_before_retry":"重连间隔时间"} ;
		}
		else {
			inputlist = {"misc_path":"执行脚本","misc_timeout":"超时时间"} ;
		} ;

		_html = format_monitor_method_input(inputlist) ;
		$("#monitor_method").html(_html) ;
	});

	$( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 600,
      width: 400,
      modal: true,
      buttons: {
        "保存": function() {
        	monitor_new = new Object ;
        	monitor = new Object ;
        	monitor_new['manager_ip'] = $("#manager_ip").val() ;
        	monitor_new['server_ip'] = $("#server_ip").val() ;
        	monitor_new['port'] = $("#rs_port").val() ;
        	monitor_new['weight'] = $("#weight").val() ;
        	monitor['type'] = $("#monitor_type").val() ;
        	$(".monitor_method_input").each(function() {
        		var key = $(this).attr('id') ;
        		var value = $(this).val() ;
        		monitor[key] = value ;
        	})
        	monitor_new['monitor'] = monitor ;
        	rs_list.push(monitor_new) ;
        	rs_table() ;
            $( this ).dialog( "close" );
        },
        Cancel: function() {
          $( this ).dialog( "close" );
        }
      },
      close: function() {
        
      }

    });

	$("#rs_add").click(function() {
		$( "#dialog-form" ).dialog( "open" );
	});

	function rs_table() {
		var html = ''
		for (rs in rs_list) {
			_rs = rs_list[rs]
			html += '<tr><td>' + _rs['manager_ip'] + '</td><td>' + _rs['server_ip'] + '</td><td>' +
			_rs['weight'] + '</td><td>' + _rs['port'] + '</td><td>' +_rs['monitor']['type'] + '</td><td><a href="javascript:rs_remove(' + rs + ')" ><span class="fui-cross"></span>delete</a></td></tr>'
		}
		$("#rs_talbe_body").html(html)
	};


	function format_monitor_method_input(input_list) {
		var html = ''
		for (i in input_list) {
			html += '<div class="control-group"><label class="control-label" for="' + i + '">' + input_list[i] + '</label> <div class="controls">' +
	     			'<td><input class="monitor_method_input" id="' + i + '" type="text" name="' + i + '"></td></div></div>'
		}
		return html
	};


	$("#lvs_deploy_add_submit").click(function() {
		var _rs_list = []
		post_data = new Object() ;
		post_data['cluster_id'] = "{{ cluster }}"
		$(".7_layer_access_new_item_input").each(function() {
			var key = $(this).attr('id') ;
			var value = $(this).val() ;
			post_data[key] = value ;
		})
		$(".lvs_manager_deploy_add_vip_checkbox").each(function() {
			var key = $(this).attr('id') ;
			var value = $(this).attr('checked') ;
			if (value == 'checked') {
				var _value = true
			} else {
				var _value = false
			}
			post_data[key] = _value ;
		})
		for (rs in rs_list) {
			if ( rs_list[rs] ) {
				_rs_list.push(rs_list[rs])
			}
		};
		post_data['rs'] = _rs_list ;
		var _post_data = $.toJSON(post_data)
		var loading=new ol.loading({id:"lvsmanager_deploy_add_body"}) ;
		$.ajax({
		  type: 'POST' ,
          url: '/lvsmanager_deploy_add/' ,
          data: _post_data ,
          cache: false ,
          beforeSend: function() { loading.show()} ,
          success: function(data) {
          		loading.hide()  ;
               	window.location.href="/lvsmanager_deploy/?id={{ cluster }}"
          },
          error: function(XMLHttpRequest) {
          	loading.hide()  ;
          	bootbox.alert('提交失败:' + XMLHttpRequest)
          }
      });

	})

	function rs_remove(rs_num) {
		delete rs_list[rs_num] ;
		rs_table() ;
	};

</script>
{% endblock %}
